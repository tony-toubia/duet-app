{
  "rules": {
    "rooms": {
      // Index for querying old rooms for cleanup
      ".indexOn": ["createdAt"],

      "$roomCode": {
        // Anyone can read room data (needed for joining)
        ".read": true,

        // Room can be created by anyone, but structure must be valid
        ".write": "!data.exists() || auth != null",

        // Validate room structure
        ".validate": "newData.hasChildren(['createdAt', 'createdBy'])",

        "createdAt": {
          ".validate": "newData.isNumber() && newData.val() <= now"
        },

        "createdBy": {
          ".validate": "newData.isString() && newData.val().length > 0"
        },

        "members": {
          "$memberId": {
            // Members can add/remove themselves (onDisconnect inherits auth from registration)
            ".write": "auth != null",
            ".validate": "newData.hasChildren(['role', 'joinedAt'])",

            "role": {
              ".validate": "newData.isString() && (newData.val() == 'offerer' || newData.val() == 'answerer')"
            },

            "joinedAt": {
              ".validate": "newData.isNumber()"
            }
          }
        },

        // WebRTC signaling data
        "offer": {
          ".write": "auth != null",
          ".validate": "newData.hasChildren(['type', 'sdp'])",

          "type": {
            ".validate": "newData.isString() && newData.val() == 'offer'"
          },

          "sdp": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length < 10000"
          }
        },

        "answer": {
          ".write": "auth != null",
          ".validate": "newData.hasChildren(['type', 'sdp'])",

          "type": {
            ".validate": "newData.isString() && newData.val() == 'answer'"
          },

          "sdp": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length < 10000"
          }
        },

        "offerCandidates": {
          "$candidateId": {
            ".write": "auth != null",
            ".validate": "newData.hasChildren(['candidate', 'sdpMid', 'sdpMLineIndex'])",

            "candidate": {
              ".validate": "newData.isString() && newData.val().length < 1000"
            },

            "sdpMid": {
              ".validate": "newData.isString()"
            },

            "sdpMLineIndex": {
              ".validate": "newData.isNumber()"
            }
          }
        },

        "answerCandidates": {
          "$candidateId": {
            ".write": "auth != null",
            ".validate": "newData.hasChildren(['candidate', 'sdpMid', 'sdpMLineIndex'])",

            "candidate": {
              ".validate": "newData.isString() && newData.val().length < 1000"
            },

            "sdpMid": {
              ".validate": "newData.isString()"
            },

            "sdpMLineIndex": {
              ".validate": "newData.isNumber()"
            }
          }
        }
      }
    },

    // User profiles and push tokens
    "users": {
      // Allow reading profiles for friend search and display
      ".read": "auth != null",
      // Index for email search
      ".indexOn": ["profile/email"],

      "$userId": {
        // Users can write their own data
        ".write": "$userId == auth.uid",

        "profile": {
          ".validate": "newData.hasChildren(['displayName'])",
          "displayName": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length < 100"
          },
          "email": {
            ".validate": "newData.isString() || newData.val() == null"
          },
          "avatarUrl": {
            ".validate": "newData.isString() || newData.val() == null"
          },
          "createdAt": {
            ".validate": "newData.isNumber()"
          },
          "authProvider": {
            ".validate": "newData.isString() && (newData.val() == 'google' || newData.val() == 'email' || newData.val() == 'anonymous')"
          },
          "friendCode": {
            ".validate": "newData.isString() && newData.val().length == 8"
          }
        },

        "pushToken": {
          ".validate": "newData.isString() && newData.val().length < 500"
        },

        "platform": {
          ".validate": "newData.isString() && (newData.val() == 'ios' || newData.val() == 'android')"
        }
      }
    },

    // Friends list
    "friends": {
      "$userId": {
        // Users can read their own friends list
        ".read": "$userId == auth.uid",

        "$friendId": {
          // Either user can write (for sending/accepting requests)
          ".write": "auth.uid == $userId || auth.uid == $friendId",
          ".validate": "newData.hasChildren(['status', 'displayName', 'initiatedBy'])",

          "status": {
            ".validate": "newData.isString() && (newData.val() == 'pending' || newData.val() == 'accepted')"
          },
          "displayName": {
            ".validate": "newData.isString()"
          },
          "avatarUrl": {
            ".validate": "newData.isString() || newData.val() == null"
          },
          "addedAt": {
            ".validate": "newData.isNumber()"
          },
          "initiatedBy": {
            ".validate": "newData.isString()"
          }
        }
      }
    },

    // Recent connections
    "recentConnections": {
      "$userId": {
        ".read": "$userId == auth.uid",
        ".write": "$userId == auth.uid",

        "$partnerId": {
          ".validate": "newData.hasChildren(['displayName', 'lastConnectedAt', 'roomCode'])"
        }
      }
    },

    // Presence/online status
    "status": {
      "$userId": {
        // Anyone authenticated can read status (for friend list online indicators)
        ".read": "auth != null",
        // Only the user can write their own status
        ".write": "$userId == auth.uid",

        "state": {
          ".validate": "newData.isString() && (newData.val() == 'online' || newData.val() == 'offline')"
        },
        "lastSeen": {
          ".validate": "newData.isNumber()"
        }
      }
    },

    // Room invitations
    "invitations": {
      "$invitationId": {
        // Anyone authenticated can read invitations addressed to them
        ".read": "auth != null && data.child('toUid').val() == auth.uid",
        // Anyone authenticated can create invitations
        ".write": "auth != null",
        ".validate": "newData.hasChildren(['fromUid', 'fromDisplayName', 'toUid', 'roomCode', 'createdAt'])"
      }
    },

    // Friend codes reverse lookup: /friendCodes/{code} -> uid
    "friendCodes": {
      "$code": {
        ".read": "auth != null",
        // Only allow writing if the code doesn't exist yet, or the current user owns it
        ".write": "auth != null && (!data.exists() || data.val() == auth.uid)",
        ".validate": "newData.isString() && newData.val() == auth.uid"
      }
    },

    // Marketing platform — admin SDK only (no client access)
    "marketing": {
      ".read": false,
      ".write": false,

      "campaigns": {
        "$campaignId": {
          "status": { ".validate": "newData.isString()" },
          "createdAt": { ".validate": "newData.isNumber()" },
          "updatedAt": { ".validate": "newData.isNumber()" },
          "sentAt": { ".validate": "newData.isNumber() || newData.val() == null" }
        }
      },

      "segments": {
        "$segmentId": {
          "lastComputedAt": { ".validate": "newData.isNumber()" },
          "memberCount": { ".validate": "newData.isNumber()" }
        }
      },

      "journeys": {
        "$journeyId": {
          "enabled": { ".validate": "newData.isBoolean()" }
        }
      },

      "journeyState": {
        "$userId": {
          "$journeyId": {
            "startedAt": { ".validate": "newData.isNumber()" },
            "currentStep": { ".validate": "newData.isNumber()" },
            "lastStepAt": { ".validate": "newData.isNumber()" },
            "completed": { ".validate": "newData.isBoolean()" }
          }
        }
      },

      "sendLog": {
        ".indexOn": ["sentAt"],
        "$logId": {
          "sentAt": { ".validate": "newData.isNumber()" },
          "success": { ".validate": "newData.isBoolean()" }
        }
      }
    },

    // Email journey state — admin SDK only (no client access)
    "emailState": {
      ".read": false,
      ".write": false,
      ".indexOn": ["welcomeSentAt"],
      "$userId": {
        "welcomeSentAt": { ".validate": "newData.isNumber()" },
        "tipsSentAt": { ".validate": "newData.isNumber()" },
        "reengagementSentAt": { ".validate": "newData.isNumber()" },
        "hasCreatedRoom": { ".validate": "newData.isBoolean()" },
        "unsubscribed": { ".validate": "newData.isBoolean()" }
      }
    },

    // Deny access to everything else
    "$other": {
      ".read": false,
      ".write": false
    }
  }
}
